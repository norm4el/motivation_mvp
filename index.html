<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Motivation MVP</title>
  <style>
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b1020;color:#eef2ff}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    h1{margin:0 0 10px}
    .muted{color:rgba(238,242,255,.72)}
    .small{font-size:13px}
    .grid{display:grid;gap:14px;grid-template-columns:1fr}
    @media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:16px}
    .label{font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:rgba(238,242,255,.7)}
    .timer{font-size:46px;font-weight:950;margin:8px 0 12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{
      padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.08);color:#eef2ff;font-weight:900;cursor:pointer
    }
    button:disabled{opacity:.5;cursor:not-allowed}
    .primary{background:rgba(99,102,241,.35);border-color:rgba(99,102,241,.55)}
    .danger{background:rgba(239,68,68,.25);border-color:rgba(239,68,68,.45)}
    .warn{background:rgba(245,158,11,.20);border-color:rgba(245,158,11,.40)}
    select{
      padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.08);color:#eef2ff;font-weight:900
    }

    .stat{font-size:28px;font-weight:950;margin-top:4px}
    .bar{height:14px;background:rgba(255,255,255,.10);border-radius:999px;overflow:hidden;margin-top:8px}
    .fill{height:100%;width:0%;background:rgba(34,197,94,.75);transition:width 180ms linear;}
    .pill{
      padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);font-weight:900
    }

    /* ===== –ø–µ—Ä—Å–æ–Ω–∞–∂ –∑–∞–Ω–∏–º–∞–µ—Ç –º–Ω–æ–≥–æ –º–µ—Å—Ç–∞ ===== */
    .characterCard{min-height:560px}
    .characterStage{
      position:relative;
      height:420px;
      border-radius:20px;
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
      background:
        radial-gradient(circle at 50% 28%, rgba(99,102,241,.25), rgba(0,0,0,0) 58%),
        rgba(255,255,255,.04);
      display:flex;align-items:flex-end;justify-content:center;
    }
    .stageGlow{
      position:absolute; inset:-50px;
      background: radial-gradient(circle at 50% 35%, rgba(99,102,241,.28), rgba(0,0,0,0) 60%);
      filter: blur(12px);
      pointer-events:none;
    }
    .charImg{
      position:relative;
      height:95%;
      width:auto;
      object-fit:contain;
      filter: drop-shadow(0 22px 42px rgba(0,0,0,.65));
      transition: transform .25s ease, filter .25s ease, opacity .18s ease;
      opacity: 1;
    }
    .characterStage.levelup .charImg{
      transform: translateY(-10px) scale(1.03);
      filter: drop-shadow(0 32px 64px rgba(99,102,241,.45));
    }
    .charMeta{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-top:12px}

    @keyframes pop { 0%{transform:scale(1)} 35%{transform:scale(1.12)} 100%{transform:scale(1)} }
    .pop{animation:pop 260ms ease}

    /* ===== –∫–∞–º–µ—Ä–∞ ===== */
    .camWrap{display:grid;gap:10px;margin-top:12px}
    .camBox{
      position:relative;
      border-radius:16px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      aspect-ratio: 16/9;
      width:100%;
      max-height:330px;
    }
    video, canvas{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
    }
    .statusLine{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .dot{width:10px;height:10px;border-radius:50%;background:#555;display:inline-block}
    .dot.ok{background:rgba(34,197,94,.85)}
    .dot.bad{background:rgba(239,68,68,.85)}
    .dot.warn{background:rgba(245,158,11,.85)}
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 12px;
      padding: 2px 6px;
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 8px;
      background: rgba(255,255,255,.06);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>–ü—Ä–æ–∫–∞—á–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</h1>
    <p class="muted">
      –¢–∞–π–º–µ—Ä + –ø—Ä–æ–∫–∞—á–∫–∞. –í —Å—Ç—Ä–æ–≥–æ–º —Ä–µ–∂–∏–º–µ –∫–∞–º–µ—Ä–∞ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç: <b>–≤ –∫–∞–¥—Ä–µ</b> / <b>–≥–ª–∞–∑–∞</b> / <b>–æ—Å–∞–Ω–∫–∞</b>.
    </p>

    <div class="grid">
      <!-- –õ–ï–í–û: –ü–ï–†–°–û–ù–ê–ñ (–ø–æ–ª–æ–≤–∏–Ω–∞ —ç–∫—Ä–∞–Ω–∞) -->
      <div class="card characterCard">
        <div class="label">–ü–µ—Ä—Å–æ–Ω–∞–∂</div>

        <div class="characterStage" id="charStage">
          <div class="stageGlow"></div>
          <img id="charImg" class="charImg" src="assets/char_01.png" alt="character">
        </div>

        <div class="charMeta">
          <div>
            <div class="label">–£—Ä–æ–≤–µ–Ω—å</div>
            <div id="level" class="stat">1</div>
          </div>
          <div>
            <div class="label">–¢–∏—Ç—É–ª</div>
            <div id="rank" class="pill">–ù–æ–≤–∏—á–æ–∫</div>
          </div>
        </div>

        <div id="reward" class="muted small" style="margin-top:10px">–ù–∞–≥—Ä–∞–¥–∞: ‚Äî</div>

        <div style="margin-top:14px">
          <div class="label">–ü—Ä–æ–≥—Ä–µ—Å—Å –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è</div>
          <div class="bar"><div id="fill" class="fill"></div></div>
          <div id="ptext" class="muted small">0%</div>
        </div>

        <p class="muted small" style="margin-top:12px">
          –ö–∞—Ä—Ç–∏–Ω–∫–∏ –±–µ—Ä—É—Ç—Å—è –∏–∑ <span class="kbd">assets/char_01.png ‚Ä¶ char_05.png</span>. –° 5 —É—Ä–æ–≤–Ω—è –æ—Å—Ç–∞—ë—Ç—Å—è 5-—è —Å—Ç–∞–¥–∏—è.
        </p>
      </div>

      <!-- –ü–†–ê–í–û: –£–ü–†–ê–í–õ–ï–ù–ò–ï + –ö–ê–ú–ï–†–ê -->
      <div class="card">
        <div class="label">–¢–∞–π–º–µ—Ä</div>
        <div id="timer" class="timer">00:00:00</div>

        <div class="btnRow">
          <button id="start" class="primary">–ó–∞ —Ä–∞–±–æ—Ç—É</button>
          <button id="stop" class="danger" disabled>–°—Ç–æ–ø</button>
          <button id="reset">–°–±—Ä–æ—Å</button>
        </div>

        <div style="margin-top:12px" class="btnRow">
          <span class="kbd">–†–µ–∂–∏–º</span>
          <select id="strictMode">
            <option value="presence">–í –∫–∞–¥—Ä–µ (–±–∞–∑–∞)</option>
            <option value="eyes">–ì–ª–∞–∑–∞ –æ—Ç–∫—Ä—ã—Ç—ã</option>
            <option value="posture">–û—Å–∞–Ω–∫–∞ (–ø–ª–µ—á–∏)</option>
          </select>

          <button id="strictOn" class="warn">–í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
          <button id="strictOff" disabled>–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
        </div>

        <div class="camWrap">
          <div class="statusLine">
            <span id="dot" class="dot"></span>
            <span id="strictStatus" class="muted small">–°—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º: –≤—ã–∫–ª—é—á–µ–Ω</span>
            <span id="poseState" class="muted small"></span>
            <span id="eyesState" class="muted small"></span>
            <span id="postureState" class="muted small"></span>
            <span id="violation" class="muted small"></span>
          </div>

          <div class="camBox" id="camBox" style="display:none">
            <video id="video" playsinline></video>
            <canvas id="canvas"></canvas>
          </div>

          <div class="row" style="margin-top:6px">
            <div>
              <div class="label">–í—Å–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏</div>
              <div id="total" class="stat">00:00:00</div>
            </div>
          </div>

          <p id="info" class="muted small"></p>
          <p class="muted small">
            –°–æ–≤–µ—Ç—ã: –¥–ª—è ‚Äú–≥–ª–∞–∑–∞‚Äù –Ω—É–∂–µ–Ω —Å–≤–µ—Ç; –¥–ª—è ‚Äú–æ—Å–∞–Ω–∫–∏‚Äù –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–∏–¥–Ω—ã –æ–±–∞ –ø–ª–µ—á–∞.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- TFJS + Pose Detection (MoveNet) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core@4.20.0/dist/tf-core.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter@4.20.0/dist/tf-converter.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl@4.20.0/dist/tf-backend-webgl.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@2.1.3/dist/pose-detection.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection@1.0.6/dist/face-landmarks-detection.min.js"></script>

<script>
  // =============================
  // A) –¢–∞–π–º–µ—Ä / —É—Ä–æ–≤–Ω–∏ (—É—Å–∫–æ—Ä–µ–Ω–æ)
  // =============================
  const BASE = 90;   // —á–µ–º –º–µ–Ω—å—à–µ ‚Äî —Ç–µ–º –±—ã—Å—Ç—Ä–µ–µ —É—Ä–æ–≤–Ω–∏
  const P = 1.18;    // —á–µ–º –º–µ–Ω—å—à–µ ‚Äî —Ç–µ–º —Å–ª–∞–±–µ–µ –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ

  const KEY = "motivation_mvp_state_v7";
  let state = loadState();
  let interval = null;

  const elTimer  = document.getElementById("timer");
  const elTotal  = document.getElementById("total");
  const elLevel  = document.getElementById("level");
  const elFill   = document.getElementById("fill");
  const elPText  = document.getElementById("ptext");
  const elInfo   = document.getElementById("info");
  const elRank   = document.getElementById("rank");
  const elReward = document.getElementById("reward");

  const btnStart = document.getElementById("start");
  const btnStop  = document.getElementById("stop");
  const btnReset = document.getElementById("reset");

  const charImg = document.getElementById("charImg");
  const charStage = document.getElementById("charStage");

  let lastLevelShown = null;

  // 5 —Å—Ç–∞–¥–∏–π –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
  const CHAR_STAGES = 5;
  function stageByLevel(level){ return Math.min(CHAR_STAGES, Math.max(1, level)); }

  btnStart.onclick = () => {
    if (state.running) return;
    state.running = true;
    state.startMs = Date.now();
    saveState();
    btnStart.disabled = true;
    btnStop.disabled = false;
    elInfo.textContent = "–°–µ—Å—Å–∏—è –Ω–∞—á–∞–ª–∞—Å—å.";
    startTick();
  };

  btnStop.onclick = () => {
    if (!state.running) return;
    const added = Math.max(0, Math.floor((Date.now() - state.startMs) / 1000));
    state.totalSeconds += added;
    state.running = false;
    state.startMs = null;
    saveState();
    stopTick();
    btnStart.disabled = false;
    btnStop.disabled = true;
    elTimer.textContent = "00:00:00";
    elInfo.textContent = `–î–æ–±–∞–≤–ª–µ–Ω–æ: ${formatHMS(added)}.`;
    render();
  };

  btnReset.onclick = () => {
    if (!confirm("–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å?")) return;
    state = { totalSeconds: 0, running: false, startMs: null };
    saveState();
    stopTick();
    btnStart.disabled = false;
    btnStop.disabled = true;
    elInfo.textContent = "";
    lastLevelShown = null;
    render();
  };

  function levelCost(level){
    return Math.max(1, Math.round(BASE * Math.pow(level, P)));
  }

  function calcLevel(totalSeconds){
    let xp = Math.max(0, Math.floor(totalSeconds));
    let level = 1;
    while(true){
      const cost = levelCost(level);
      if (xp >= cost) { xp -= cost; level++; }
      else return { level, xpInLevel: xp, xpToNext: cost, progress: xp / cost };
    }
  }

  function titleByLevel(level){
    if (level >= 10) return "–õ–µ–≥–µ–Ω–¥–∞";
    if (level >= 8) return "–ú–æ–Ω—Å—Ç—Ä";
    if (level >= 6) return "–≠–ª–∏—Ç–∞";
    if (level >= 4) return "–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞";
    if (level >= 2) return "–†–∞–∑–æ–≥—Ä–µ–≤";
    return "–ù–æ–≤–∏—á–æ–∫";
  }

  function rewardText(level){
    const s = stageByLevel(level);
    if (s === 1) return "–°—Ç–∞—Ä—Ç. –¢—ã –Ω–∞—á–∞–ª.";
    if (s === 2) return "–£–∂–µ –ª—É—á—à–µ. –î–µ—Ä–∂–∏—à—å—Å—è.";
    if (s === 3) return "–°—Ç–∞–±–∏–ª—å–Ω–æ. –ü—Ä–∏–≤—ã—á–∫–∞ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è.";
    if (s === 4) return "–°–∏–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å. –¢—ã —Å–æ–±—Ä–∞–Ω.";
    return "–§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞–¥–∏—è. –¢–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å.";
  }

  function startTick(){
    if (interval) clearInterval(interval);
    interval = setInterval(() => {
      const runSec = state.running ? Math.floor((Date.now() - state.startMs) / 1000) : 0;
      elTimer.textContent = formatHMS(runSec);
      render();
    }, 250);
  }

  function stopTick(){
    if (interval) clearInterval(interval);
    interval = null;
  }

  function render(){
    const runSec = (state.running && state.startMs) ? Math.max(0, Math.floor((Date.now() - state.startMs) / 1000)) : 0;
    const total = state.totalSeconds + runSec;

    elTotal.textContent = formatHMS(total);

    const info = calcLevel(total);
    elLevel.textContent = String(info.level);

    const pct = Math.floor(info.progress * 100);
    elFill.style.width = pct + "%";
    elPText.textContent = `${pct}% (–≤ —É—Ä–æ–≤–Ω–µ: ${info.xpInLevel} / ${info.xpToNext} —Å–µ–∫)`;

    // —Å–º–µ–Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –ø–æ —É—Ä–æ–≤–Ω—é (1..5, –¥–∞–ª—å—à–µ 5)
    const stage = stageByLevel(info.level);
    if (charImg) {
      const nextSrc = `assets/char_${String(stage).padStart(2,'0')}.png`;
      if (!charImg.src.endsWith(nextSrc)) {
        // –º—è–≥–∫–∞—è —Å–º–µ–Ω–∞ –±–µ–∑ –¥–µ—Ä–≥–∞–Ω—å—è
        charImg.style.opacity = "0.0";
        setTimeout(() => {
          charImg.src = nextSrc;
          charImg.onload = () => { charImg.style.opacity = "1.0"; };
          // –µ—Å–ª–∏ –∫–µ—à ‚Äî onload –º–æ–∂–µ—Ç –Ω–µ —Å—Ä–∞–±–æ—Ç–∞—Ç—å
          setTimeout(() => { charImg.style.opacity = "1.0"; }, 80);
        }, 80);
      }
    }

    // —Ç–∏—Ç—É–ª/–Ω–∞–≥—Ä–∞–¥–∞
    elRank.textContent = titleByLevel(info.level);
    elReward.textContent = "–ù–∞–≥—Ä–∞–¥–∞: " + rewardText(info.level);

    // pop-—ç—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –∞–ø–µ
    if (lastLevelShown === null) lastLevelShown = info.level;
    if (info.level !== lastLevelShown) {
      elLevel.classList.remove("pop"); void elLevel.offsetWidth; elLevel.classList.add("pop");
      if (charStage) { charStage.classList.remove("levelup"); void charStage.offsetWidth; charStage.classList.add("levelup"); }
      lastLevelShown = info.level;
    }

    if (state.running) { btnStart.disabled = true; btnStop.disabled = false; }
  }

  function formatHMS(totalSeconds){
    const s = Math.max(0, Math.floor(totalSeconds));
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    const sec = s % 60;
    return [h,m,sec].map(n => String(n).padStart(2,"0")).join(":");
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(KEY);
      if (!raw) return { totalSeconds: 0, running: false, startMs: null };
      const s = JSON.parse(raw);
      return { totalSeconds: Number(s.totalSeconds) || 0, running: Boolean(s.running), startMs: (typeof s.startMs === "number" ? s.startMs : null) };
    } catch {
      return { totalSeconds: 0, running: false, startMs: null };
    }
  }
  function saveState(){ localStorage.setItem(KEY, JSON.stringify(state)); }

  // =============================
  // B) –°—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º: MoveNet + FaceMesh + —Å–∏—Ä–µ–Ω–∞
  // =============================
  const btnStrictOn  = document.getElementById("strictOn");
  const btnStrictOff = document.getElementById("strictOff");
  const modeEl = document.getElementById("strictMode");

  const elStrictStatus = document.getElementById("strictStatus");
  const elViolation = document.getElementById("violation");
  const elPoseState = document.getElementById("poseState");
  const elEyesState = document.getElementById("eyesState");
  const elPostureState = document.getElementById("postureState");
  const elDot = document.getElementById("dot");

  const camBox = document.getElementById("camBox");
  const videoEl = document.getElementById("video");
  const canvasEl = document.getElementById("canvas");
  const ctx = canvasEl.getContext("2d");

  // –ü–æ—Ä–æ–≥–∏
  const POSE_MISSING_MS = 2000;
  const EYES_CLOSED_MS = 1200;
  const EAR_THRESHOLD = 0.18;
  const POSTURE_BAD_MS = 1200;
  const SHOULDER_LEVEL_RATIO = 0.07;

  let strictEnabled = false;
  let detector = null;
  let faceDetector = null;
  let rafId = null;
  let stream = null;

  let lastPoseSeenMs = 0;
  let eyesClosedSince = null;
  let postureBadSince = null;

  let violationReason = ""; // "presence" | "eyes" | "posture" | ""
  let violationActive = false;

  let coverTransform = { r: 1, x: 0, y: 0, nw: 0, nh: 0, vw: 0, vh: 0 };

  // —Å–∏—Ä–µ–Ω–∞
  let audioCtx = null, osc = null, gain = null, sirenTimer = null, sirenHigh = false;

  btnStrictOn.onclick = async () => {
    try { await enableStrictMode(); }
    catch (e) {
      console.error(e);
      setStatus("warn", "–°—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º: –æ—à–∏–±–∫–∞");
      elViolation.textContent = "–û—à–∏–±–∫–∞. –û—Ç–∫—Ä–æ–π –∫–æ–Ω—Å–æ–ª—å (F12) –∏ –ø—Ä–∏—à–ª–∏ —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏.";
    }
  };
  btnStrictOff.onclick = async () => { await disableStrictMode(); };

  async function enableStrictMode(){
    if (strictEnabled) return;
    strictEnabled = true;

    btnStrictOn.disabled = true;
    btnStrictOff.disabled = false;
    camBox.style.display = "block";

    initSirenAudio();
    syncCanvasSize();
    window.addEventListener("resize", syncCanvasSize);

    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "user", width: { ideal: 1280 }, height: { ideal: 720 } },
      audio: false
    });
    videoEl.srcObject = stream;
    videoEl.muted = true;
    await videoEl.play();

    await tf.setBackend("webgl");
    await tf.ready();

    detector = await poseDetection.createDetector(
      poseDetection.SupportedModels.MoveNet,
      { modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING, enableSmoothing: true }
    );

    faceDetector = await faceLandmarksDetection.createDetector(
      faceLandmarksDetection.SupportedModels.MediaPipeFaceMesh,
      { runtime: "tfjs", refineLandmarks: true, maxFaces: 1 }
    );

    lastPoseSeenMs = Date.now();
    eyesClosedSince = null;
    postureBadSince = null;
    violationReason = "";
    violationActive = false;

    setStatus("ok", "–°—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º: –≤–∫–ª—é—á—ë–Ω");
    elViolation.textContent = "";
    elPoseState.textContent = "";
    elEyesState.textContent = "";
    elPostureState.textContent = "";

    loop();
  }

  async function disableStrictMode(){
    if (!strictEnabled) return;
    strictEnabled = false;

    btnStrictOn.disabled = false;
    btnStrictOff.disabled = true;
    camBox.style.display = "none";
    window.removeEventListener("resize", syncCanvasSize);

    stopSiren();

    if (rafId) cancelAnimationFrame(rafId);
    rafId = null;

    try { if (detector) await detector.dispose(); } catch {}
    detector = null;

    try { if (faceDetector) await faceDetector.dispose(); } catch {}
    faceDetector = null;

    try { if (stream) stream.getTracks().forEach(t => t.stop()); } catch {}
    stream = null;

    videoEl.srcObject = null;
    ctx.clearRect(0,0,canvasEl.width,canvasEl.height);

    setStatus("", "–°—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º: –≤—ã–∫–ª—é—á–µ–Ω");
    elViolation.textContent = "";
    elPoseState.textContent = "";
    elEyesState.textContent = "";
    elPostureState.textContent = "";

    eyesClosedSince = null;
    postureBadSince = null;
    violationReason = "";
    violationActive = false;
  }

  function syncCanvasSize(){
    const rect = camBox.getBoundingClientRect();
    canvasEl.width = Math.floor(rect.width);
    canvasEl.height = Math.floor(rect.height);
  }

  function drawVideoCover(video, ctx, w, h){
    if (!video.videoWidth || !video.videoHeight) return;
    const vw = video.videoWidth, vh = video.videoHeight;
    const r = Math.max(w / vw, h / vh);
    const nw = vw * r, nh = vh * r;
    const x = (w - nw) / 2;
    const y = (h - nh) / 2;
    ctx.drawImage(video, x, y, nw, nh);
    coverTransform = { r, x, y, nw, nh, vw, vh };
  }

  function mapToCanvas(px, py){
    const { r, x, y } = coverTransform;
    return { cx: px * r + x, cy: py * r + y };
  }

  const EDGES = [
    [5,7],[7,9],
    [6,8],[8,10],
    [5,6],
    [5,11],[6,12],
    [11,12],
    [11,13],[13,15],
    [12,14],[14,16]
  ];

  function drawKeypoint(cx, cy){
    ctx.beginPath();
    ctx.arc(cx, cy, 3, 0, Math.PI*2);
    ctx.fill();
  }
  function drawLine(ax, ay, bx, by){
    ctx.beginPath();
    ctx.moveTo(ax, ay);
    ctx.lineTo(bx, by);
    ctx.stroke();
  }

  function setViolation(reason, text){
    if (!strictEnabled) return;
    if (!violationActive) {
      violationActive = true;
      violationReason = reason;
      elViolation.textContent = text;
      setStatus("bad", "–°—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º: –ù–ê–†–£–®–ï–ù–ò–ï");
      startSiren();
    }
  }

  function clearViolationIfReason(reason){
    if (violationActive && violationReason === reason) {
      violationActive = false;
      violationReason = "";
      elViolation.textContent = "";
      setStatus("ok", "–°—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º: –≤–∫–ª—é—á—ë–Ω");
      stopSiren();
    }
  }

  function updatePresence(hasPose){
    if (hasPose) lastPoseSeenMs = Date.now();
    const missingFor = Date.now() - lastPoseSeenMs;

    if (missingFor > POSE_MISSING_MS) {
      setViolation("presence", "–ù–∞—Ä—É—à–µ–Ω–∏–µ: —Ç–µ–±—è –Ω–µ –≤–∏–¥–Ω–æ. –°–ò–†–ï–ù–ê!");
      elPoseState.textContent = "–ü–æ–∑–∞: –Ω–µ –≤–∏–∂—É ‚ùå";
    } else {
      elPoseState.textContent = hasPose ? "–ü–æ–∑–∞: –Ω–∞–π–¥–µ–Ω–∞ ‚úÖ" : "–ü–æ–∑–∞: –∏—â—É‚Ä¶";
      clearViolationIfReason("presence");
    }
  }

  function checkPosture(kp){
    const L = kp[5], R = kp[6];
    if (!L || !R || (L.score ?? 0) < 0.25 || (R.score ?? 0) < 0.25) {
      elPostureState.textContent = "–û—Å–∞–Ω–∫–∞: –Ω–µ –≤–∏–∂—É –ø–ª–µ—á–∏ ü§∑";
      postureBadSince = null;
      clearViolationIfReason("posture");
      return;
    }
    const shoulderWidth = Math.abs(L.x - R.x);
    if (shoulderWidth < 20) {
      elPostureState.textContent = "–û—Å–∞–Ω–∫–∞: —Å–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ ü§∑";
      postureBadSince = null;
      clearViolationIfReason("posture");
      return;
    }
    const dy = Math.abs(L.y - R.y);
    const ratio = dy / shoulderWidth;

    if (ratio > SHOULDER_LEVEL_RATIO) {
      elPostureState.textContent = `–û—Å–∞–Ω–∫–∞: –∫—Ä–∏–≤–æ ‚ùå (Œî‚âà${Math.round(ratio*100)}%)`;
      if (!postureBadSince) postureBadSince = Date.now();
      if (Date.now() - postureBadSince > POSTURE_BAD_MS) {
        setViolation("posture", "–ù–∞—Ä—É—à–µ–Ω–∏–µ: –æ—Å–∞–Ω–∫–∞ (–ø–ª–µ—á–∏ –Ω–µ—Ä–æ–≤–Ω–æ). –°–ò–†–ï–ù–ê!");
      }
    } else {
      elPostureState.textContent = "–û—Å–∞–Ω–∫–∞: —Ä–æ–≤–Ω–æ ‚úÖ";
      postureBadSince = null;
      clearViolationIfReason("posture");
    }
  }

  function dist2D(a, b){
    const dx = a[0] - b[0];
    const dy = a[1] - b[1];
    return Math.hypot(dx, dy);
  }

  function computeEARFromFace(face){
    const ann = face.annotations;
    if (!ann || !ann.leftEyeUpper0 || !ann.leftEyeLower0 || !ann.rightEyeUpper0 || !ann.rightEyeLower0) return null;

    function eyeEAR(upper, lower){
      const leftCorner  = upper[0];
      const rightCorner = upper[upper.length - 1];
      const v1 = dist2D(upper[2], lower[2]);
      const v2 = dist2D(upper[4], lower[4]);
      const h  = dist2D(leftCorner, rightCorner);
      return (v1 + v2) / (2.0 * h);
    }

    const leftEAR  = eyeEAR(ann.leftEyeUpper0,  ann.leftEyeLower0);
    const rightEAR = eyeEAR(ann.rightEyeUpper0, ann.rightEyeLower0);
    return (leftEAR + rightEAR) / 2;
  }

  async function checkEyes(){
    if (!faceDetector || !strictEnabled) return;

    const faces = await faceDetector.estimateFaces(videoEl, { flipHorizontal: true });

    if (!faces || !faces.length) {
      elEyesState.textContent = "–õ–∏—Ü–æ: –Ω–µ –≤–∏–∂—É ‚ùå";
      eyesClosedSince = null;
      clearViolationIfReason("eyes");
      return;
    }

    const ear = computeEARFromFace(faces[0]);
    if (ear == null) {
      elEyesState.textContent = "–ì–ª–∞–∑–∞: –Ω–µ –≤–∏–∂—É ü§∑";
      eyesClosedSince = null;
      clearViolationIfReason("eyes");
      return;
    }

    if (ear < EAR_THRESHOLD) {
      elEyesState.textContent = "–ì–ª–∞–∑–∞: –∑–∞–∫—Ä—ã—Ç—ã ‚ùå";
      if (!eyesClosedSince) eyesClosedSince = Date.now();
      if (Date.now() - eyesClosedSince > EYES_CLOSED_MS) {
        setViolation("eyes", "–ù–∞—Ä—É—à–µ–Ω–∏–µ: –≥–ª–∞–∑–∞ –∑–∞–∫—Ä—ã—Ç—ã. –°–ò–†–ï–ù–ê!");
      }
    } else {
      elEyesState.textContent = "–ì–ª–∞–∑–∞: –æ—Ç–∫—Ä—ã—Ç—ã ‚úÖ";
      eyesClosedSince = null;
      clearViolationIfReason("eyes");
    }
  }

  async function loop(){
    if (!strictEnabled || !detector) return;

    const mode = modeEl ? modeEl.value : "presence";

    const poses = await detector.estimatePoses(videoEl, { flipHorizontal: true });
    const hasPose = !!(poses && poses.length && poses[0].keypoints && poses[0].keypoints.length);

    ctx.save();
    ctx.clearRect(0,0,canvasEl.width,canvasEl.height);
    drawVideoCover(videoEl, ctx, canvasEl.width, canvasEl.height);

    if (hasPose) {
      const kp = poses[0].keypoints;
      ctx.strokeStyle = "rgba(99,102,241,0.9)";
      ctx.lineWidth = 3;
      ctx.fillStyle = "rgba(34,197,94,0.9)";

      for (const [a,b] of EDGES) {
        const A = kp[a], B = kp[b];
        if ((A.score ?? 0) > 0.25 && (B.score ?? 0) > 0.25) {
          const a2 = mapToCanvas(A.x, A.y);
          const b2 = mapToCanvas(B.x, B.y);
          drawLine(a2.cx, a2.cy, b2.cx, b2.cy);
        }
      }
      for (const p of kp) {
        if ((p.score ?? 0) > 0.25) {
          const c = mapToCanvas(p.x, p.y);
          drawKeypoint(c.cx, c.cy);
        }
      }
    }
    ctx.restore();

    // –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –≤—Å–µ—Ö —Ä–µ–∂–∏–º–æ–≤
    updatePresence(hasPose);

    // —Å–±—Ä–æ—Å –ª–∏—à–Ω–∏—Ö —Å—Ç–∞—Ç—É—Å–æ–≤
    if (mode !== "eyes") elEyesState.textContent = "";
    if (mode !== "posture") elPostureState.textContent = "";

    if (mode === "posture") {
      if (hasPose) checkPosture(poses[0].keypoints);
      else {
        elPostureState.textContent = "–û—Å–∞–Ω–∫–∞: –Ω–µ –≤–∏–∂—É ü§∑";
        postureBadSince = null;
        clearViolationIfReason("posture");
      }
    }

    if (mode === "eyes") {
      await checkEyes();
    } else {
      eyesClosedSince = null;
      clearViolationIfReason("eyes");
    }

    rafId = requestAnimationFrame(loop);
  }

  function setStatus(dotState, title){
    elStrictStatus.textContent = title;
    elDot.className = "dot";
    if (dotState === "ok") elDot.classList.add("ok");
    if (dotState === "bad") elDot.classList.add("bad");
    if (dotState === "warn") elDot.classList.add("warn");
    if (!dotState) elDot.className = "dot";
  }

  function initSirenAudio(){
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    gain = audioCtx.createGain();
    gain.gain.value = 0.0;
    gain.connect(audioCtx.destination);

    osc = audioCtx.createOscillator();
    osc.type = "sawtooth";
    osc.frequency.value = 880;
    osc.connect(gain);
    osc.start();
  }

  function startSiren(){
    if (!audioCtx) initSirenAudio();
    if (audioCtx.state === "suspended") audioCtx.resume();
    if (sirenTimer) return;

    gain.gain.value = 0.0;
    sirenHigh = false;

    sirenTimer = setInterval(() => {
      sirenHigh = !sirenHigh;
      const freq = sirenHigh ? 1100 : 650;
      osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
      gain.gain.setValueAtTime(0.15, audioCtx.currentTime);
    }, 180);
  }

  function stopSiren(){
    if (!gain) return;
    gain.gain.setValueAtTime(0.0, audioCtx ? audioCtx.currentTime : 0);
    if (sirenTimer) { clearInterval(sirenTimer); sirenTimer = null; }
  }

  // Init
  render();
  if (state.running && typeof state.startMs === "number") startTick();
  else { btnStart.disabled = false; btnStop.disabled = true; }
  setStatus("", "–°—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º: –≤—ã–∫–ª—é—á–µ–Ω");
</script>
</body>
</html>

<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Motivation MVP</title>
  <style>
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b1020;color:#eef2ff}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    h1{margin:0 0 10px}
    .muted{color:rgba(238,242,255,.72)}
    .small{font-size:13px}
    .grid{display:grid;gap:14px;grid-template-columns:1fr}
    @media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:16px}
    .label{font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:rgba(238,242,255,.7)}
    .timer{font-size:46px;font-weight:950;margin:8px 0 12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{
      padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.08);color:#eef2ff;font-weight:900;cursor:pointer
    }
    button:disabled{opacity:.5;cursor:not-allowed}
    .primary{background:rgba(99,102,241,.35);border-color:rgba(99,102,241,.55)}
    .danger{background:rgba(239,68,68,.25);border-color:rgba(239,68,68,.45)}
    .warn{background:rgba(245,158,11,.20);border-color:rgba(245,158,11,.40)}
    .okbtn{background:rgba(34,197,94,.20);border-color:rgba(34,197,94,.38)}
    select, input{
      padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.08);color:#eef2ff;font-weight:900
    }
    input[type="number"]{width:130px}

    .stat{font-size:28px;font-weight:950;margin-top:4px}
    .bar{height:14px;background:rgba(255,255,255,.10);border-radius:999px;overflow:hidden;margin-top:8px}
    .fill{height:100%;width:0%;background:rgba(34,197,94,.75);transition:width 180ms linear;}
    .pill{
      padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);font-weight:900
    }

    .tabs{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:14px 0 10px}
    .tabBtn{
      padding:10px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);font-weight:950;cursor:pointer;
    }
    .tabBtn.active{background:rgba(99,102,241,.35);border-color:rgba(99,102,241,.55)}
    .tabPage[hidden]{display:none !important;}

    .characterCard{min-height:560px}
    .characterStage{
      position:relative;height:420px;border-radius:20px;border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
      background:
        radial-gradient(circle at 50% 28%, rgba(99,102,241,.25), rgba(0,0,0,0) 58%),
        rgba(255,255,255,.04);
      display:flex;align-items:flex-end;justify-content:center;
    }
    .stageGlow{
      position:absolute; inset:-50px;
      background: radial-gradient(circle at 50% 35%, rgba(99,102,241,.28), rgba(0,0,0,0) 60%);
      filter: blur(12px);
      pointer-events:none;
    }
    .charImg{
      position:relative;height:95%;width:auto;object-fit:contain;
      filter: drop-shadow(0 22px 42px rgba(0,0,0,.65));
      transition: transform .25s ease, filter .25s ease, opacity .18s ease;
      opacity: 1;
    }
    .characterStage.levelup .charImg{
      transform: translateY(-10px) scale(1.03);
      filter: drop-shadow(0 32px 64px rgba(99,102,241,.45));
    }
    .charMeta{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-top:12px}
    @keyframes pop { 0%{transform:scale(1)} 35%{transform:scale(1.12)} 100%{transform:scale(1)} }
    .pop{animation:pop 260ms ease}

    .camWrap{display:grid;gap:10px;margin-top:12px}
    .camBox{
      position:relative;border-radius:16px;overflow:hidden;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);aspect-ratio: 16/9;width:100%;max-height:340px;
    }
    video, canvas{position:absolute; inset:0;width:100%; height:100%;object-fit:cover;}
    .statusLine{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .dot{width:10px;height:10px;border-radius:50%;background:#555;display:inline-block}
    .dot.ok{background:rgba(34,197,94,.85)}
    .dot.bad{background:rgba(239,68,68,.85)}
    .dot.warn{background:rgba(245,158,11,.85)}
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 12px; padding: 2px 6px;border: 1px solid rgba(255,255,255,.14);
      border-radius: 8px;background: rgba(255,255,255,.06);
    }

    .toggle{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .toggle input{transform:scale(1.2)}
    .warnText{color:rgba(245,158,11,.95);font-weight:900}
    .badText{color:rgba(239,68,68,.95);font-weight:900}
    .okText{color:rgba(34,197,94,.95);font-weight:900}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>–ü—Ä–æ–∫–∞—á–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</h1>
    <p class="muted">
      –¢–∞–π–º–µ—Ä + –ø—Ä–æ–∫–∞—á–∫–∞. 30/5. –¶–µ–ª—å –¥–Ω—è + streak + –±–æ–Ω—É—Å –∫ XP. –ö–∞–º–µ—Ä–∞/—Ä–µ–∂–∏–º—ã ‚Äî –≤–æ –≤–∫–ª–∞–¥–∫–µ ‚Äú–§—É–Ω–∫—Ü–∏–∏‚Äù.
    </p>

    <div class="tabs" role="tablist" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
      <button class="tabBtn active" id="tabBtnMain" data-tab="main" role="tab" aria-selected="true">–ì–ª–∞–≤–Ω–∞—è</button>
      <button class="tabBtn" id="tabBtnFeatures" data-tab="features" role="tab" aria-selected="false">–§—É–Ω–∫—Ü–∏–∏</button>
    </div>

    <!-- ====== MAIN ====== -->
    <section class="tabPage" id="tab-main">
      <div class="grid">
        <div class="card characterCard">
          <div class="label">–ü–µ—Ä—Å–æ–Ω–∞–∂</div>

          <div class="characterStage" id="charStage">
            <div class="stageGlow"></div>
            <img id="charImg" class="charImg" src="assets/char_01.png" alt="character">
          </div>

          <div class="charMeta">
            <div>
              <div class="label">–£—Ä–æ–≤–µ–Ω—å</div>
              <div id="level" class="stat">1</div>
            </div>
            <div>
              <div class="label">–¢–∏—Ç—É–ª</div>
              <div id="rank" class="pill">–ù–æ–≤–∏—á–æ–∫</div>
            </div>
          </div>

          <div id="reward" class="muted small" style="margin-top:10px">–ù–∞–≥—Ä–∞–¥–∞: ‚Äî</div>

          <div style="margin-top:14px">
            <div class="label">–ü—Ä–æ–≥—Ä–µ—Å—Å –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è</div>
            <div class="bar"><div id="fill" class="fill"></div></div>
            <div id="ptext" class="muted small">0%</div>
          </div>

          <p class="muted small" style="margin-top:12px">
            –ö–∞—Ä—Ç–∏–Ω–∫–∏: <span class="kbd">assets/char_01.png ‚Ä¶ char_05.png</span>. –° 5 —É—Ä–æ–≤–Ω—è –æ—Å—Ç–∞—ë—Ç—Å—è 5-—è —Å—Ç–∞–¥–∏—è.
          </p>
        </div>

        <div class="card">
          <div class="label">–°–µ—Å—Å–∏—è</div>

          <div class="row" style="margin-top:6px">
            <div class="pill" id="cyclePill">–°–µ–π—á–∞—Å: ‚Äî</div>
            <div class="pill"><span class="kbd" id="cycleHint">‚Äî</span></div>
          </div>

          <div id="timer" class="timer">00:00:00</div>

          <div class="btnRow">
            <button id="start" class="primary">–ó–∞ —Ä–∞–±–æ—Ç—É</button>
            <button id="stop" class="danger" disabled>–°—Ç–æ–ø</button>
            <button id="reset">–°–±—Ä–æ—Å</button>
            <button id="skipBreak" class="okbtn" disabled>–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –ø–µ—Ä–µ—Ä—ã–≤</button>
          </div>

          <div class="row" style="margin-top:12px">
            <div>
              <div class="label">XP-–≤—Ä–µ–º—è</div>
              <div id="total" class="stat">00:00:00</div>
            </div>
            <div class="pill" style="align-self:flex-end">
              <span class="kbd">–ö–∞–º–µ—Ä–∞ ‚Üí</span> –≤–∫–ª–∞–¥–∫–∞ <b>–§—É–Ω–∫—Ü–∏–∏</b>
            </div>
          </div>

          <div class="card" style="margin-top:14px;padding:14px;border-radius:14px">
            <div class="row">
              <div class="label">Anti-cheat</div>
              <div class="pill" id="honestPill">–ß–µ—Å—Ç–Ω—ã–π XP: ‚Äî</div>
            </div>
            <div class="toggle" style="margin-top:10px">
              <input id="honestToggle" type="checkbox">
              <span class="muted small"><b>–ß–µ—Å—Ç–Ω—ã–π XP</b>: –Ω–∞—á–∏—Å–ª—è—Ç—å XP —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–Ω–æ–π –∫–∞–º–µ—Ä–µ –∏ –±–µ–∑ –Ω–∞—Ä—É—à–µ–Ω–∏–π</span>
            </div>
            <div id="honestReason" class="muted small" style="margin-top:10px"></div>
          </div>

          <div class="card" style="margin-top:14px;padding:14px;border-radius:14px">
            <div class="row">
              <div class="label">–¶–µ–ª—å –¥–Ω—è</div>
              <div class="pill" id="streakPill">Streak: 0 üî•</div>
            </div>

            <div class="btnRow" style="margin-top:10px">
              <span class="kbd">–¶–µ–ª—å</span>
              <input id="goalMin" type="number" min="5" step="5" value="60" />
              <span class="muted small">–º–∏–Ω</span>
              <span class="pill" id="bonusPill">–ë–æ–Ω—É—Å: 1.00x</span>
            </div>

            <div style="margin-top:10px">
              <div class="label">–°–µ–≥–æ–¥–Ω—è (—á–µ—Å—Ç–Ω—ã–µ –º–∏–Ω—É—Ç—ã)</div>
              <div class="bar"><div id="goalFill" class="fill"></div></div>
              <div id="goalText" class="muted small">0 / 60 –º–∏–Ω</div>
            </div>
          </div>

          <div class="card" style="margin-top:14px;padding:14px;border-radius:14px">
            <div class="row">
              <div class="label">–°–∏–ª–∞ (–æ—Ç–∂–∏–º–∞–Ω–∏—è)</div>
              <div class="pill" id="strPill">–°–∏–ª–∞: —É—Ä. 1</div>
            </div>
            <div class="row" style="margin-top:10px">
              <div class="pill">–í—Å–µ–≥–æ –æ—Ç–∂–∏–º–∞–Ω–∏–π: <span id="pushTotal">0</span></div>
              <div class="pill">–î–æ —Å–ª–µ–¥. —É—Ä–æ–≤–Ω—è: <span id="pushToNext">10</span></div>
            </div>
            <div style="margin-top:10px">
              <div class="label">–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–∏–ª—ã</div>
              <div class="bar"><div id="strFill" class="fill"></div></div>
              <div id="strText" class="muted small">0 / 10</div>
            </div>
            <p class="muted small" style="margin-top:10px">
              –ü—Ä–∞–≤–∏–ª–æ: <b>10 –æ—Ç–∂–∏–º–∞–Ω–∏–π = +1 —É—Ä–æ–≤–µ–Ω—å —Å–∏–ª—ã</b>.
            </p>
          </div>

          <p id="info" class="muted small" style="margin-top:10px"></p>

          <div class="statusLine" style="margin-top:10px">
            <span class="dot js-dot"></span>
            <span class="muted small js-strictStatus">–ö–æ–Ω—Ç—Ä–æ–ª—å: –≤—ã–∫–ª—é—á–µ–Ω</span>
            <span class="muted small js-violation"></span>
          </div>

          <p class="muted small" style="margin-top:10px">
            –ù–∞ –ø–µ—Ä–µ—Ä—ã–≤–µ –∫–æ–Ω—Ç—Ä–æ–ª—å –ø–∞—É–∑–∞ ‚Äî –º–æ–∂–Ω–æ –≤—Å—Ç–∞—Ç—å/—É–π—Ç–∏.
          </p>
        </div>
      </div>
    </section>

    <!-- ====== FEATURES ====== -->
    <section class="tabPage" id="tab-features" hidden>
      <div class="grid">
        <!-- STRICT CONTROL -->
        <div class="card">
          <div class="label">–ö–æ–Ω—Ç—Ä–æ–ª—å (—Å—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º)</div>
          <p class="muted small" style="margin-top:6px">
            –î–ª—è anti-cheat –∏ ‚Äú–Ω–µ –æ—Ç–≤–ª–µ–∫–∞—Ç—å—Å—è‚Äù. –ü—Ä–æ–≤–µ—Ä–∫–∏: –≤ –∫–∞–¥—Ä–µ / –≥–ª–∞–∑–∞ / –æ—Å–∞–Ω–∫–∞.
          </p>

          <div class="btnRow" style="margin-top:12px">
            <span class="kbd">–ü—Ä–æ—Ñ–∏–ª—å</span>
            <select id="preset">
              <option value="light">–õ–∞–π—Ç (—Ç–æ–ª—å–∫–æ –≤ –∫–∞–¥—Ä–µ)</option>
              <option value="normal">–ù–æ—Ä–º (–≤ –∫–∞–¥—Ä–µ + –≥–ª–∞–∑–∞)</option>
              <option value="hard">–•–∞—Ä–¥ (–≤ –∫–∞–¥—Ä–µ + –≥–ª–∞–∑–∞ + –æ—Å–∞–Ω–∫–∞)</option>
            </select>

            <span class="kbd">–†–µ–∂–∏–º</span>
            <select id="strictMode">
              <option value="presence">–í –∫–∞–¥—Ä–µ (–±–∞–∑–∞)</option>
              <option value="eyes">–ì–ª–∞–∑–∞ –æ—Ç–∫—Ä—ã—Ç—ã</option>
              <option value="posture">–û—Å–∞–Ω–∫–∞ (–ø–ª–µ—á–∏)</option>
            </select>
          </div>

          <div class="btnRow" style="margin-top:10px">
            <button id="strictOn" class="warn">–í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
            <button id="strictOff" disabled>–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
          </div>

          <div class="camWrap">
            <div class="statusLine">
              <span class="dot js-dot"></span>
              <span class="muted small js-strictStatus">–ö–æ–Ω—Ç—Ä–æ–ª—å: –≤—ã–∫–ª—é—á–µ–Ω</span>
              <span class="muted small js-violation"></span>
            </div>

            <div class="statusLine">
              <span class="kbd">–ü–æ–∑–∞:</span> <span class="muted small js-poseState"></span>
              <span class="kbd">–ì–ª–∞–∑–∞:</span> <span class="muted small js-eyesState"></span>
              <span class="kbd">–û—Å–∞–Ω–∫–∞:</span> <span class="muted small js-postureState"></span>
            </div>

            <p class="muted small">
              –°–æ–≤–µ—Ç—ã: —Å–≤–µ—Ç –¥–ª—è ‚Äú–≥–ª–∞–∑‚Äù; –¥–ª—è ‚Äú–æ—Å–∞–Ω–∫–∏‚Äù –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–∏–¥–Ω—ã –æ–±–∞ –ø–ª–µ—á–∞.
            </p>
          </div>
        </div>

        <!-- PUSHUPS FEATURE -->
        <div class="card">
          <div class="label">–û—Ç–∂–∏–º–∞–Ω–∏—è (–∫–∞–º–µ—Ä–∞)</div>
          <p class="muted small" style="margin-top:6px">
            –°—á–∏—Ç–∞–µ—Ç –ø–æ —É–≥–ª—É –ª–æ–∫—Ç—è (–ø–ª–µ—á–æ‚Äì–ª–æ–∫–æ—Ç—å‚Äì–∑–∞–ø—è—Å—Ç—å–µ). –õ—É—á—à–µ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã ‚Äî <b>—Å–±–æ–∫—É (–ø—Ä–æ—Ñ–∏–ª—å)</b>.
          </p>

          <div class="btnRow" style="margin-top:12px">
            <button id="pushOn" class="primary">–ó–∞–ø—É—Å—Ç–∏—Ç—å –æ—Ç–∂–∏–º–∞–Ω–∏—è</button>
            <button id="pushOff" class="danger" disabled>–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
            <button id="pushResetSession">–°–±—Ä–æ—Å —Å–µ—Å—Å–∏–∏</button>
            <button id="pushResetTotal" class="danger">–°–±—Ä–æ—Å –æ–±—â–µ–≥–æ</button>
          </div>

          <div class="row" style="margin-top:12px">
            <div class="pill">–°–µ—Å—Å–∏—è: <span id="pushSession">0</span></div>
            <div class="pill">–í—Å–µ–≥–æ: <span id="pushTotal2">0</span></div>
            <div class="pill">–°–∏–ª–∞: <span id="str2">—É—Ä. 1</span></div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="pill" id="pushPhase">–§–∞–∑–∞: ‚Äî</div>
            <div class="pill" id="pushAngle">–£–≥–æ–ª: ‚Äî</div>
          </div>

          <div style="margin-top:10px">
            <div class="label">–î–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è —Å–∏–ª—ã (10)</div>
            <div class="bar"><div id="strFill2" class="fill"></div></div>
            <div id="strText2" class="muted small">0 / 10</div>
          </div>

          <div class="camWrap">
            <div class="camBox" id="camBox" style="display:none">
              <video id="video" playsinline></video>
              <canvas id="canvas"></canvas>
            </div>
            <p class="muted small" id="pushHint"></p>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- TFJS + Pose Detection (MoveNet) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core@4.20.0/dist/tf-core.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter@4.20.0/dist/tf-converter.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl@4.20.0/dist/tf-backend-webgl.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@2.1.3/dist/pose-detection.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection@1.0.6/dist/face-landmarks-detection.min.js"></script>

<script>
  // =============================
  // 0) Tabs
  // =============================
  (function initTabs(){
    const btnMain = document.getElementById("tabBtnMain");
    const btnFeatures = document.getElementById("tabBtnFeatures");
    const tabMain = document.getElementById("tab-main");
    const tabFeatures = document.getElementById("tab-features");
    function setTab(which){
      const isMain = which === "main";
      tabMain.hidden = !isMain;
      tabFeatures.hidden = isMain;
      btnMain.classList.toggle("active", isMain);
      btnFeatures.classList.toggle("active", !isMain);
      btnMain.setAttribute("aria-selected", String(isMain));
      btnFeatures.setAttribute("aria-selected", String(!isMain));
    }
    btnMain.addEventListener("click", () => setTab("main"));
    btnFeatures.addEventListener("click", () => setTab("features"));
  })();

  // =============================
  // A) Timer / Levels / 30-5 / Goals / Honest XP
  // =============================
  const WORK_BLOCK_MS  = 30 * 60 * 1000;
  const BREAK_BLOCK_MS =  5 * 60 * 1000;

  const BASE = 90;
  const P = 1.18;

  const KEY = "motivation_mvp_state_v13_pushups_strength";

  let state = loadState();
  let interval = null;
  let carryMs = 0;
  let lastTickMs = null;
  let lastLevelShown = null;

  const elTimer  = document.getElementById("timer");
  const elTotal  = document.getElementById("total");
  const elLevel  = document.getElementById("level");
  const elFill   = document.getElementById("fill");
  const elPText  = document.getElementById("ptext");
  const elInfo   = document.getElementById("info");
  const elRank   = document.getElementById("rank");
  const elReward = document.getElementById("reward");
  const elCyclePill = document.getElementById("cyclePill");
  const elCycleHint = document.getElementById("cycleHint");

  const btnStart = document.getElementById("start");
  const btnStop  = document.getElementById("stop");
  const btnReset = document.getElementById("reset");
  const btnSkipBreak = document.getElementById("skipBreak");

  const goalMinEl = document.getElementById("goalMin");
  const goalFillEl = document.getElementById("goalFill");
  const goalTextEl = document.getElementById("goalText");
  const streakPillEl = document.getElementById("streakPill");
  const bonusPillEl = document.getElementById("bonusPill");

  const honestToggleEl = document.getElementById("honestToggle");
  const honestPillEl = document.getElementById("honestPill");
  const honestReasonEl = document.getElementById("honestReason");

  const charImg = document.getElementById("charImg");
  const charStage = document.getElementById("charStage");

  // Strength UI (Main)
  const strPillEl = document.getElementById("strPill");
  const pushTotalMainEl = document.getElementById("pushTotal");
  const pushToNextMainEl = document.getElementById("pushToNext");
  const strFillMainEl = document.getElementById("strFill");
  const strTextMainEl = document.getElementById("strText");

  // Features controls
  const presetEl = document.getElementById("preset");
  const strictModeEl = document.getElementById("strictMode");

  function todayStr(){
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  }
  function clampInt(v, a, b){ return Math.max(a, Math.min(b, Math.floor(v))); }

  function isBreakMode(){ return state.cycleMode === "break"; }
  function cycleDurationMs(){ return isBreakMode() ? BREAK_BLOCK_MS : WORK_BLOCK_MS; }

  function bonusMultiplier(streak){
    const mult = 1 + 0.05 * Math.max(0, Math.floor(streak));
    return Math.min(1.50, Math.round(mult * 100) / 100);
  }

  function ensureTodayFresh(){
    const t = todayStr();
    if (state.todayDate !== t) {
      finalizeDayAndUpdateStreak();
      state.todayDate = t;
      state.todayWorkMs = 0;
      state.todayGoalDone = false;
    }
  }

  function finalizeDayAndUpdateStreak(){
    const goalMs = state.goalMinutes * 60 * 1000;
    const done = state.todayWorkMs >= goalMs;
    state.streak = done ? (state.streak || 0) + 1 : 0;
    state.todayGoalDone = done;
  }

  function presetName(p){
    if (p === "hard") return "–•–∞—Ä–¥";
    if (p === "normal") return "–ù–æ—Ä–º";
    return "–õ–∞–π—Ç";
  }
  function presetChecksText(cfg){
    const arr = ["–≤ –∫–∞–¥—Ä–µ"];
    if (cfg.allowEyes) arr.push("–≥–ª–∞–∑–∞");
    if (cfg.allowPosture) arr.push("–æ—Å–∞–Ω–∫–∞");
    return arr.join(" + ");
  }

  function getPresetConfig(){
    const p = state.strictPreset || "normal";
    if (p === "light") {
      return {
        allowEyes: false,
        allowPosture: false,
        POSE_MISSING_MS: 2200,
        EYES_CLOSED_MS: 999999,
        EAR_THRESHOLD: 0.18,
        POSTURE_BAD_MS: 999999,
        SHOULDER_LEVEL_RATIO: 0.07
      };
    }
    if (p === "hard") {
      return {
        allowEyes: true,
        allowPosture: true,
        POSE_MISSING_MS: 1200,
        EYES_CLOSED_MS: 700,
        EAR_THRESHOLD: 0.20,
        POSTURE_BAD_MS: 700,
        SHOULDER_LEVEL_RATIO: 0.05
      };
    }
    return {
      allowEyes: true,
      allowPosture: false,
      POSE_MISSING_MS: 2000,
      EYES_CLOSED_MS: 1200,
      EAR_THRESHOLD: 0.18,
      POSTURE_BAD_MS: 999999,
      SHOULDER_LEVEL_RATIO: 0.07
    };
  }

  goalMinEl.value = String(state.goalMinutes);
  honestToggleEl.checked = !!state.honestMode;
  presetEl.value = state.strictPreset || "normal";

  goalMinEl.addEventListener("change", () => {
    const v = Number(goalMinEl.value);
    state.goalMinutes = clampInt(isFinite(v) ? v : 60, 5, 600);
    goalMinEl.value = String(state.goalMinutes);
    saveState();
    render();
  });

  honestToggleEl.addEventListener("change", () => {
    state.honestMode = !!honestToggleEl.checked;
    saveState();
    render();
  });

  presetEl.addEventListener("change", () => {
    state.strictPreset = presetEl.value;
    const cfg = getPresetConfig();
    if (!cfg.allowEyes && !cfg.allowPosture) strictModeEl.value = "presence";
    if (cfg.allowEyes && !cfg.allowPosture && strictModeEl.value === "posture") strictModeEl.value = "eyes";
    saveState();
    render();
  });

  btnStart.onclick = () => {
    if (state.running) return;
    ensureTodayFresh();

    state.running = true;
    state.startMs = Date.now();
    if (!state.cycleMode) state.cycleMode = "work";
    if (typeof state.cycleElapsedMs !== "number") state.cycleElapsedMs = 0;

    lastTickMs = Date.now();
    carryMs = 0;

    saveState();
    btnStart.disabled = true;
    btnStop.disabled = false;
    elInfo.textContent = "–°–µ—Å—Å–∏—è –Ω–∞—á–∞–ª–∞—Å—å.";
    startTick();
  };

  btnStop.onclick = () => {
    if (!state.running) return;

    processTick();

    state.running = false;
    state.startMs = null;
    lastTickMs = null;
    carryMs = 0;

    saveState();
    stopTick();

    btnStart.disabled = false;
    btnStop.disabled = true;
    btnSkipBreak.disabled = true;

    elInfo.textContent = `–°—Ç–æ–ø. XP-–≤—Ä–µ–º—è: ${formatHMS(state.totalSeconds)}.`;
    render();
  };

  btnReset.onclick = () => {
    if (!confirm("–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å?")) return;

    state = {
      totalSeconds: 0,
      running: false,
      startMs: null,
      cycleMode: "work",
      cycleElapsedMs: 0,

      goalMinutes: 60,
      streak: 0,
      todayDate: todayStr(),
      todayWorkMs: 0,
      todayGoalDone: false,
      lastSaveMs: 0,

      honestMode: true,
      strictPreset: "normal",

      // strength
      pushupsTotal: 0
    };

    saveState();
    stopTick();

    btnStart.disabled = false;
    btnStop.disabled = true;
    btnSkipBreak.disabled = true;

    presetEl.value = state.strictPreset;
    elInfo.textContent = "";
    lastLevelShown = null;
    render();
  };

  btnSkipBreak.onclick = () => {
    if (!state.running) return;
    if (!isBreakMode()) return;
    switchCycleTo("work", "–ü–µ—Ä–µ—Ä—ã–≤ –ø—Ä–æ–ø—É—â–µ–Ω. –í–ø–µ—Ä—ë–¥!");
    saveState();
    render();
  };

  function levelCost(level){
    return Math.max(1, Math.round(BASE * Math.pow(level, P)));
  }

  function calcLevel(totalSeconds){
    let xp = Math.max(0, Math.floor(totalSeconds));
    let level = 1;
    while(true){
      const cost = levelCost(level);
      if (xp >= cost) { xp -= cost; level++; }
      else return { level, xpInLevel: xp, xpToNext: cost, progress: xp / cost };
    }
  }

  function titleByLevel(level){
    if (level >= 10) return "–õ–µ–≥–µ–Ω–¥–∞";
    if (level >= 8) return "–ú–æ–Ω—Å—Ç—Ä";
    if (level >= 6) return "–≠–ª–∏—Ç–∞";
    if (level >= 4) return "–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞";
    if (level >= 2) return "–†–∞–∑–æ–≥—Ä–µ–≤";
    return "–ù–æ–≤–∏—á–æ–∫";
  }

  const CHAR_STAGES = 5;
  function stageByLevel(level){ return Math.min(CHAR_STAGES, Math.max(1, level)); }

  function rewardText(level){
    const s = stageByLevel(level);
    if (s === 1) return "–°—Ç–∞—Ä—Ç. –¢—ã –Ω–∞—á–∞–ª.";
    if (s === 2) return "–£–∂–µ –ª—É—á—à–µ. –î–µ—Ä–∂–∏—à—å—Å—è.";
    if (s === 3) return "–°—Ç–∞–±–∏–ª—å–Ω–æ. –ü—Ä–∏–≤—ã—á–∫–∞ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è.";
    if (s === 4) return "–°–∏–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å. –¢—ã —Å–æ–±—Ä–∞–Ω.";
    return "–§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞–¥–∏—è. –¢–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å.";
  }

  function startTick(){
    if (interval) clearInterval(interval);
    interval = setInterval(() => {
      processTick();
      render();
    }, 250);
  }

  function stopTick(){
    if (interval) clearInterval(interval);
    interval = null;
  }

  function advanceCycle(dtMs){
    state.cycleElapsedMs += dtMs;
    while (state.cycleElapsedMs >= cycleDurationMs()) {
      state.cycleElapsedMs -= cycleDurationMs();
      const next = isBreakMode() ? "work" : "break";
      if (next === "break") switchCycleTo("break", "–ü–µ—Ä–µ—Ä—ã–≤ 5 –º–∏–Ω—É—Ç. –í—Å—Ç–∞–Ω—å, —Ä–∞–∑–æ–º–Ω–∏—Å—å.");
      else switchCycleTo("work", "–†–∞–±–æ—Ç–∞ 30 –º–∏–Ω—É—Ç. –ü–æ–µ—Ö–∞–ª–∏.");
    }
  }

  function switchCycleTo(mode, msg){
    state.cycleMode = mode;

    if (mode === "break") {
      stopSiren();
      clearAllViolationUI();
    }

    elInfo.textContent = msg;
    btnSkipBreak.disabled = !(state.running && mode === "break");
  }

  function honestAllowed(){
    if (!state.honestMode) return { ok:true, reason:"" };
    if (isBreakMode()) return { ok:false, reason:"–ø–µ—Ä–µ—Ä—ã–≤ (XP –ø–∞—É–∑–∞)" };
    if (!strictEnabled) return { ok:false, reason:"–≤–∫–ª—é—á–∏ –∫–æ–Ω—Ç—Ä–æ–ª—å (–§—É–Ω–∫—Ü–∏–∏ ‚Üí –ö–æ–Ω—Ç—Ä–æ–ª—å ‚Üí –í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É)" };
    if (violationActive) return { ok:false, reason:"–∏—Å–ø—Ä–∞–≤—å –Ω–∞—Ä—É—à–µ–Ω–∏–µ (—Å–∏—Ä–µ–Ω–∞/—Å—Ç–∞—Ç—É—Å)" };
    return { ok:true, reason:"" };
  }

  function processTick(){
    if (!state.running) return;

    ensureTodayFresh();

    const now = Date.now();
    if (!lastTickMs) lastTickMs = now;

    let dt = now - lastTickMs;
    if (dt < 0) dt = 0;
    lastTickMs = now;

    advanceCycle(dt);

    const mult = bonusMultiplier(state.streak);

    if (!isBreakMode()) {
      const ok = honestAllowed();

      if (ok.ok) {
        state.todayWorkMs += dt;

        carryMs += dt * mult;
        while (carryMs >= 1000) {
          state.totalSeconds += 1;
          carryMs -= 1000;
        }
      } else {
        carryMs = 0;
      }

      const goalMs = state.goalMinutes * 60 * 1000;
      state.todayGoalDone = state.todayWorkMs >= goalMs;
    } else {
      carryMs = 0;
    }

    if (!state.lastSaveMs) state.lastSaveMs = 0;
    if (now - state.lastSaveMs > 2000) {
      state.lastSaveMs = now;
      saveState();
    }
  }

  // ===== strength helpers =====
  function strengthLevelFromTotal(totalPushups){
    // 10 –æ—Ç–∂–∏–º–∞–Ω–∏–π = +1 —É—Ä–æ–≤–µ–Ω—å. –ù–∞—á–∏–Ω–∞–µ–º —Å 1.
    return Math.floor(Math.max(0, totalPushups) / 10) + 1;
  }
  function strengthProgress(totalPushups){
    const mod = Math.max(0, totalPushups) % 10;
    return { done: mod, toNext: 10 - mod, pct: (mod / 10) };
  }
  function renderStrength(){
    const total = Number(state.pushupsTotal) || 0;
    const lvl = strengthLevelFromTotal(total);
    const pr = strengthProgress(total);

    strPillEl.textContent = `–°–∏–ª–∞: —É—Ä. ${lvl}`;
    pushTotalMainEl.textContent = String(total);
    pushToNextMainEl.textContent = String(pr.toNext === 10 ? 10 : pr.toNext);

    const pct = Math.floor(pr.pct * 100);
    strFillMainEl.style.width = pct + "%";
    strTextMainEl.textContent = `${pr.done} / 10`;

    // –¥—É–±–ª–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ —Ñ—É–Ω–∫—Ü–∏–π
    pushTotal2El.textContent = String(total);
    str2El.textContent = `—É—Ä. ${lvl}`;

    strFill2El.style.width = pct + "%";
    strText2El.textContent = `${pr.done} / 10`;
  }

  function render(){
    const remainingMs = Math.max(0, cycleDurationMs() - state.cycleElapsedMs);
    elTimer.textContent = formatHMSms(remainingMs);

    const modeLabel = isBreakMode() ? "–ü–µ—Ä–µ—Ä—ã–≤" : "–†–∞–±–æ—Ç–∞";
    elCyclePill.textContent = `–°–µ–π—á–∞—Å: ${modeLabel}`;
    elCycleHint.textContent = isBreakMode()
      ? `–¥–æ —Ä–∞–±–æ—Ç—ã: ${formatHMSms(remainingMs)}`
      : `–¥–æ –ø–µ—Ä–µ—Ä—ã–≤–∞: ${formatHMSms(remainingMs)}`;

    btnSkipBreak.disabled = !(state.running && isBreakMode());
    if (!state.running) btnSkipBreak.disabled = true;

    elTotal.textContent = formatHMS(state.totalSeconds);

    const info = calcLevel(state.totalSeconds);
    elLevel.textContent = String(info.level);

    const pct = Math.floor(info.progress * 100);
    elFill.style.width = pct + "%";
    elPText.textContent = `${pct}% (–≤ —É—Ä–æ–≤–Ω–µ: ${info.xpInLevel} / ${info.xpToNext} —Å–µ–∫)`;

    const stage = stageByLevel(info.level);
    const nextSrc = `assets/char_${String(stage).padStart(2,'0')}.png`;
    if (charImg && !charImg.src.endsWith(nextSrc)) {
      charImg.style.opacity = "0.0";
      setTimeout(() => {
        charImg.src = nextSrc;
        charImg.onload = () => { charImg.style.opacity = "1.0"; };
        setTimeout(() => { charImg.style.opacity = "1.0"; }, 80);
      }, 80);
    }

    elRank.textContent = titleByLevel(info.level);
    elReward.textContent = "–ù–∞–≥—Ä–∞–¥–∞: " + rewardText(info.level);

    if (lastLevelShown === null) lastLevelShown = info.level;
    if (info.level !== lastLevelShown) {
      elLevel.classList.remove("pop"); void elLevel.offsetWidth; elLevel.classList.add("pop");
      if (charStage) { charStage.classList.remove("levelup"); void charStage.offsetWidth; charStage.classList.add("levelup"); }
      lastLevelShown = info.level;
    }

    ensureTodayFresh();
    const goalMin = state.goalMinutes;
    const doneMin = Math.floor(state.todayWorkMs / 60000);
    const goalMs = goalMin * 60 * 1000;
    const prog = goalMs > 0 ? Math.min(1, state.todayWorkMs / goalMs) : 0;

    goalFillEl.style.width = Math.floor(prog * 100) + "%";
    goalTextEl.textContent = `${doneMin} / ${goalMin} –º–∏–Ω` + (state.todayGoalDone ? " ‚úÖ" : "");
    streakPillEl.textContent = `Streak: ${state.streak} üî•`;

    const mult = bonusMultiplier(state.streak);
    bonusPillEl.textContent = `–ë–æ–Ω—É—Å: ${mult.toFixed(2)}x`;

    const h = honestAllowed();
    if (!state.honestMode) {
      honestPillEl.textContent = "–ß–µ—Å—Ç–Ω—ã–π XP: OFF";
      honestReasonEl.innerHTML = `<span class="warnText">XP –±–µ–∑ –∫–æ–Ω—Ç—Ä–æ–ª—è</span> (–º–æ–∂–Ω–æ –Ω–∞–∫—Ä—É—Ç–∏—Ç—å)`;
    } else {
      honestPillEl.textContent = h.ok ? "–ß–µ—Å—Ç–Ω—ã–π XP: OK ‚úÖ" : "–ß–µ—Å—Ç–Ω—ã–π XP: –ü–ê–£–ó–ê ‚è∏";
      honestReasonEl.innerHTML = h.ok
        ? `<span class="okText">XP –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è</span>`
        : `<span class="badText">XP –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:</span> ${escapeHtml(h.reason)}`;
    }

    if (state.running) { btnStart.disabled = true; btnStop.disabled = false; }
    else { btnStart.disabled = false; btnStop.disabled = true; }

    renderStrength();
  }

  function escapeHtml(s){
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  function formatHMS(totalSeconds){
    const s = Math.max(0, Math.floor(totalSeconds));
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    const sec = s % 60;
    return [h,m,sec].map(n => String(n).padStart(2,"0")).join(":");
  }
  function formatHMSms(ms){
    const s = Math.max(0, Math.floor(ms / 1000));
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    const sec = s % 60;
    return [h,m,sec].map(n => String(n).padStart(2,"0")).join(":");
  }

  function loadState(){
    const base = {
      totalSeconds: 0,
      running: false,
      startMs: null,
      cycleMode: "work",
      cycleElapsedMs: 0,

      goalMinutes: 60,
      streak: 0,
      todayDate: todayStr(),
      todayWorkMs: 0,
      todayGoalDone: false,
      lastSaveMs: 0,

      honestMode: true,
      strictPreset: "normal",

      pushupsTotal: 0
    };
    try{
      const raw = localStorage.getItem(KEY);
      if (!raw) return base;
      const s = JSON.parse(raw);
      return {
        totalSeconds: Number(s.totalSeconds) || 0,
        running: Boolean(s.running),
        startMs: (typeof s.startMs === "number" ? s.startMs : null),
        cycleMode: (s.cycleMode === "break" ? "break" : "work"),
        cycleElapsedMs: (typeof s.cycleElapsedMs === "number" ? Math.max(0, s.cycleElapsedMs) : 0),

        goalMinutes: clampInt(Number(s.goalMinutes) || 60, 5, 600),
        streak: Number.isFinite(Number(s.streak)) ? Math.max(0, Math.floor(Number(s.streak))) : 0,
        todayDate: (typeof s.todayDate === "string" ? s.todayDate : todayStr()),
        todayWorkMs: (typeof s.todayWorkMs === "number" ? Math.max(0, s.todayWorkMs) : 0),
        todayGoalDone: Boolean(s.todayGoalDone),
        lastSaveMs: (typeof s.lastSaveMs === "number" ? s.lastSaveMs : 0),

        honestMode: (typeof s.honestMode === "boolean" ? s.honestMode : true),
        strictPreset: (s.strictPreset === "light" || s.strictPreset === "hard" || s.strictPreset === "normal") ? s.strictPreset : "normal",

        pushupsTotal: (typeof s.pushupsTotal === "number" ? Math.max(0, Math.floor(s.pushupsTotal)) : 0)
      };
    } catch {
      return base;
    }
  }
  function saveState(){ localStorage.setItem(KEY, JSON.stringify(state)); }

  // =============================
  // B) Camera Core: shared camera + detectors
  // =============================
  const btnStrictOn  = document.getElementById("strictOn");
  const btnStrictOff = document.getElementById("strictOff");

  const btnPushOn = document.getElementById("pushOn");
  const btnPushOff = document.getElementById("pushOff");
  const btnPushResetSession = document.getElementById("pushResetSession");
  const btnPushResetTotal = document.getElementById("pushResetTotal");

  const camBox = document.getElementById("camBox");
  const videoEl = document.getElementById("video");
  const canvasEl = document.getElementById("canvas");
  const ctx = canvasEl.getContext("2d");

  // Pushups UI (Features)
  const pushSessionEl = document.getElementById("pushSession");
  const pushTotal2El = document.getElementById("pushTotal2");
  const str2El = document.getElementById("str2");
  const pushPhaseEl = document.getElementById("pushPhase");
  const pushAngleEl = document.getElementById("pushAngle");
  const strFill2El = document.getElementById("strFill2");
  const strText2El = document.getElementById("strText2");
  const pushHintEl = document.getElementById("pushHint");

  const $strictStatus = () => Array.from(document.querySelectorAll(".js-strictStatus"));
  const $violation    = () => Array.from(document.querySelectorAll(".js-violation"));
  const $dot          = () => Array.from(document.querySelectorAll(".js-dot"));
  const $poseState    = () => Array.from(document.querySelectorAll(".js-poseState"));
  const $eyesState    = () => Array.from(document.querySelectorAll(".js-eyesState"));
  const $postureState = () => Array.from(document.querySelectorAll(".js-postureState"));
  function setAllText(nodes, text){ nodes.forEach(n => n.textContent = text); }

  let cameraOn = false;
  let detector = null;
  let faceDetector = null;
  let rafId = null;
  let stream = null;

  let coverTransform = { r: 1, x: 0, y: 0, nw: 0, nh: 0, vw: 0, vh: 0 };

  // strict state
  let strictEnabled = false;
  let lastPoseSeenMs = 0;
  let eyesClosedSince = null;
  let postureBadSince = null;
  let violationReason = "";
  let violationActive = false;

  // pushups state (separate feature)
  let pushupsEnabled = false;
  let pushupsSession = 0;
  let pushPhase = "UP"; // UP/DOWN
  let pushLastRepMs = 0;
  let pushStableUp = 0;
  let pushStableDown = 0;

  // thresholds
  const PUSH_UP_ANGLE = 155;
  const PUSH_DOWN_ANGLE = 95;
  const PUSH_MIN_INTERVAL_MS = 350;
  const PUSH_STABLE_FRAMES = 3;

  // siren
  let audioCtx = null, osc = null, gain = null, sirenTimer = null, sirenHigh = false;

  function syncCanvasSize(){
    const rect = camBox.getBoundingClientRect();
    canvasEl.width = Math.floor(rect.width);
    canvasEl.height = Math.floor(rect.height);
  }

  async function ensureCameraOn(){
    if (cameraOn) return;

    camBox.style.display = "block";
    syncCanvasSize();
    window.addEventListener("resize", syncCanvasSize);

    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "user", width: { ideal: 1280 }, height: { ideal: 720 } },
      audio: false
    });
    videoEl.srcObject = stream;
    videoEl.muted = true;
    await videoEl.play();

    await tf.setBackend("webgl");
    await tf.ready();

    detector = await poseDetection.createDetector(
      poseDetection.SupportedModels.MoveNet,
      { modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING, enableSmoothing: true }
    );

    faceDetector = await faceLandmarksDetection.createDetector(
      faceLandmarksDetection.SupportedModels.MediaPipeFaceMesh,
      { runtime: "tfjs", refineLandmarks: true, maxFaces: 1 }
    );

    cameraOn = true;
    initSirenAudio();
    loop();
  }

  async function stopCameraIfUnused(){
    // –µ—Å–ª–∏ –Ω–∏ —Å—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º, –Ω–∏ –æ—Ç–∂–∏–º–∞–Ω–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç ‚Äî –≤—ã–∫–ª—é—á–∞–µ–º –∫–∞–º–µ—Ä—É
    if (strictEnabled || pushupsEnabled) return;

    cameraOn = false;

    if (rafId) cancelAnimationFrame(rafId);
    rafId = null;

    stopSiren();

    try { if (detector) await detector.dispose(); } catch {}
    detector = null;

    try { if (faceDetector) await faceDetector.dispose(); } catch {}
    faceDetector = null;

    try { if (stream) stream.getTracks().forEach(t => t.stop()); } catch {}
    stream = null;

    videoEl.srcObject = null;
    ctx.clearRect(0,0,canvasEl.width,canvasEl.height);

    camBox.style.display = "none";
    window.removeEventListener("resize", syncCanvasSize);
  }

  function drawVideoCover(video, ctx, w, h){
    if (!video.videoWidth || !video.videoHeight) return;
    const vw = video.videoWidth, vh = video.videoHeight;
    const r = Math.max(w / vw, h / vh);
    const nw = vw * r, nh = vh * r;
    const x = (w - nw) / 2;
    const y = (h - nh) / 2;
    ctx.drawImage(video, x, y, nw, nh);
    coverTransform = { r, x, y, nw, nh, vw, vh };
  }

  function mapToCanvas(px, py){
    const { r, x, y } = coverTransform;
    return { cx: px * r + x, cy: py * r + y };
  }

  const EDGES = [
    [5,7],[7,9],
    [6,8],[8,10],
    [5,6],
    [5,11],[6,12],
    [11,12],
    [11,13],[13,15],
    [12,14],[14,16]
  ];

  function drawKeypoint(cx, cy){
    ctx.beginPath();
    ctx.arc(cx, cy, 3, 0, Math.PI*2);
    ctx.fill();
  }

  function setStatus(dotState, title){
    setAllText($strictStatus(), title);
    $dot().forEach(d => {
      d.className = "dot js-dot";
      if (dotState === "ok") d.classList.add("ok");
      if (dotState === "bad") d.classList.add("bad");
      if (dotState === "warn") d.classList.add("warn");
    });
  }

  function initSirenAudio(){
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    gain = audioCtx.createGain();
    gain.gain.value = 0.0;
    gain.connect(audioCtx.destination);

    osc = audioCtx.createOscillator();
    osc.type = "sawtooth";
    osc.frequency.value = 880;
    osc.connect(gain);
    osc.start();
  }

  function startSiren(){
    if (!audioCtx) initSirenAudio();
    if (audioCtx.state === "suspended") audioCtx.resume();
    if (sirenTimer) return;

    gain.gain.value = 0.0;
    sirenHigh = false;

    sirenTimer = setInterval(() => {
      sirenHigh = !sirenHigh;
      const freq = sirenHigh ? 1100 : 650;
      osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
      gain.gain.setValueAtTime(0.15, audioCtx.currentTime);
    }, 180);
  }

  function stopSiren(){
    if (!gain) return;
    gain.gain.setValueAtTime(0.0, audioCtx ? audioCtx.currentTime : 0);
    if (sirenTimer) { clearInterval(sirenTimer); sirenTimer = null; }
  }

  function clearAllViolationUI(){
    violationActive = false;
    violationReason = "";
    setAllText($violation(), "");
  }

  function setViolation(reason, text){
    if (!strictEnabled) return;
    if (isBreakMode()) return;
    if (!violationActive) {
      violationActive = true;
      violationReason = reason;
      setAllText($violation(), text);
      setStatus("bad", "–ö–æ–Ω—Ç—Ä–æ–ª—å: –ù–ê–†–£–®–ï–ù–ò–ï");
      startSiren();
    }
  }

  function clearViolationIfReason(reason){
    if (violationActive && violationReason === reason) {
      violationActive = false;
      violationReason = "";
      setAllText($violation(), "");
      setStatus("ok", "–ö–æ–Ω—Ç—Ä–æ–ª—å: –≤–∫–ª—é—á—ë–Ω");
      stopSiren();
    }
  }

  function updatePresence(hasPose){
    const cfg = getPresetConfig();

    if (isBreakMode()) {
      setAllText($poseState(), "–ø–µ—Ä–µ—Ä—ã–≤: –ø–∞—É–∑–∞ ‚úÖ");
      clearViolationIfReason("presence");
      return;
    }

    if (hasPose) lastPoseSeenMs = Date.now();
    const missingFor = Date.now() - lastPoseSeenMs;

    if (missingFor > cfg.POSE_MISSING_MS) {
      setViolation("presence", "–ù–∞—Ä—É—à–µ–Ω–∏–µ: —Ç–µ–±—è –Ω–µ –≤–∏–¥–Ω–æ. –°–ò–†–ï–ù–ê!");
      setAllText($poseState(), "–Ω–µ –≤–∏–∂—É ‚ùå");
    } else {
      setAllText($poseState(), hasPose ? "–Ω–∞–π–¥–µ–Ω–∞ ‚úÖ" : "–∏—â—É‚Ä¶");
      clearViolationIfReason("presence");
    }
  }

  function checkPosture(kp){
    const cfg = getPresetConfig();
    if (!cfg.allowPosture) {
      setAllText($postureState(), "‚Äî (–ø—Ä–æ—Ñ–∏–ª—å –æ—Ç–∫–ª—é—á–∏–ª)");
      postureBadSince = null;
      clearViolationIfReason("posture");
      return;
    }

    if (isBreakMode()) {
      setAllText($postureState(), "");
      postureBadSince = null;
      clearViolationIfReason("posture");
      return;
    }

    const L = kp[5], R = kp[6];
    if (!L || !R || (L.score ?? 0) < 0.25 || (R.score ?? 0) < 0.25) {
      setAllText($postureState(), "–Ω–µ –≤–∏–∂—É –ø–ª–µ—á–∏ ü§∑");
      postureBadSince = null;
      clearViolationIfReason("posture");
      return;
    }

    const shoulderWidth = Math.abs(L.x - R.x);
    if (shoulderWidth < 20) {
      setAllText($postureState(), "—Å–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ ü§∑");
      postureBadSince = null;
      clearViolationIfReason("posture");
      return;
    }

    const dy = Math.abs(L.y - R.y);
    const ratio = dy / shoulderWidth;

    if (ratio > cfg.SHOULDER_LEVEL_RATIO) {
      setAllText($postureState(), `–∫—Ä–∏–≤–æ ‚ùå (Œî‚âà${Math.round(ratio*100)}%)`);
      if (!postureBadSince) postureBadSince = Date.now();
      if (Date.now() - postureBadSince > cfg.POSTURE_BAD_MS) {
        setViolation("posture", "–ù–∞—Ä—É—à–µ–Ω–∏–µ: –æ—Å–∞–Ω–∫–∞ (–ø–ª–µ—á–∏ –Ω–µ—Ä–æ–≤–Ω–æ). –°–ò–†–ï–ù–ê!");
      }
    } else {
      setAllText($postureState(), "—Ä–æ–≤–Ω–æ ‚úÖ");
      postureBadSince = null;
      clearViolationIfReason("posture");
    }
  }

  function dist2D(a, b){
    const dx = a[0] - b[0];
    const dy = a[1] - b[1];
    return Math.hypot(dx, dy);
  }

  function computeEARFromFace(face){
    const ann = face.annotations;
    if (!ann || !ann.leftEyeUpper0 || !ann.leftEyeLower0 || !ann.rightEyeUpper0 || !ann.rightEyeLower0) return null;

    function eyeEAR(upper, lower){
      const leftCorner  = upper[0];
      const rightCorner = upper[upper.length - 1];
      const v1 = dist2D(upper[2], lower[2]);
      const v2 = dist2D(upper[4], lower[4]);
      const h  = dist2D(leftCorner, rightCorner);
      return (v1 + v2) / (2.0 * h);
    }

    const leftEAR  = eyeEAR(ann.leftEyeUpper0,  ann.leftEyeLower0);
    const rightEAR = eyeEAR(ann.rightEyeUpper0, ann.rightEyeLower0);
    return (leftEAR + rightEAR) / 2;
  }

  async function checkEyes(){
    const cfg = getPresetConfig();
    if (!cfg.allowEyes) {
      setAllText($eyesState(), "‚Äî (–ø—Ä–æ—Ñ–∏–ª—å –æ—Ç–∫–ª—é—á–∏–ª)");
      eyesClosedSince = null;
      clearViolationIfReason("eyes");
      return;
    }
    if (!faceDetector || !cameraOn) return;

    if (isBreakMode()) {
      setAllText($eyesState(), "");
      eyesClosedSince = null;
      clearViolationIfReason("eyes");
      return;
    }

    const faces = await faceDetector.estimateFaces(videoEl, { flipHorizontal: true });

    if (!faces || !faces.length) {
      setAllText($eyesState(), "–ª–∏—Ü–æ: –Ω–µ –≤–∏–∂—É ‚ùå");
      eyesClosedSince = null;
      clearViolationIfReason("eyes");
      return;
    }

    const ear = computeEARFromFace(faces[0]);
    if (ear == null) {
      setAllText($eyesState(), "–Ω–µ –≤–∏–∂—É ü§∑");
      eyesClosedSince = null;
      clearViolationIfReason("eyes");
      return;
    }

    if (ear < cfg.EAR_THRESHOLD) {
      setAllText($eyesState(), "–∑–∞–∫—Ä—ã—Ç—ã ‚ùå");
      if (!eyesClosedSince) eyesClosedSince = Date.now();
      if (Date.now() - eyesClosedSince > cfg.EYES_CLOSED_MS) {
        setViolation("eyes", "–ù–∞—Ä—É—à–µ–Ω–∏–µ: –≥–ª–∞–∑–∞ –∑–∞–∫—Ä—ã—Ç—ã. –°–ò–†–ï–ù–ê!");
      }
    } else {
      setAllText($eyesState(), "–æ—Ç–∫—Ä—ã—Ç—ã ‚úÖ");
      eyesClosedSince = null;
      clearViolationIfReason("eyes");
    }
  }

  // ===== push-ups math =====
  function angleDeg(A, B, C){
    const abx = A.x - B.x, aby = A.y - B.y;
    const cbx = C.x - B.x, cby = C.y - B.y;
    const ab = Math.hypot(abx, aby);
    const cb = Math.hypot(cbx, cby);
    if (ab < 1e-6 || cb < 1e-6) return null;
    const dot = abx*cbx + aby*cby;
    let cos = dot / (ab * cb);
    cos = Math.max(-1, Math.min(1, cos));
    return Math.acos(cos) * 180 / Math.PI;
  }

  function bestElbowAngle(kp){
    const MIN = 0.25;

    const Ls = kp[5], Le = kp[7], Lw = kp[9];
    const Rs = kp[6], Re = kp[8], Rw = kp[10];

    const leftOk = Ls && Le && Lw && (Ls.score??0)>MIN && (Le.score??0)>MIN && (Lw.score??0)>MIN;
    const rightOk = Rs && Re && Rw && (Rs.score??0)>MIN && (Re.score??0)>MIN && (Rw.score??0)>MIN;

    const angles = [];
    if (leftOk) {
      const a = angleDeg(Ls, Le, Lw);
      if (a != null) angles.push(a);
    }
    if (rightOk) {
      const a = angleDeg(Rs, Re, Rw);
      if (a != null) angles.push(a);
    }
    if (!angles.length) return null;
    return angles.reduce((s,x)=>s+x,0) / angles.length;
  }

  function pushupsResetSession(){
    pushupsSession = 0;
    pushPhase = "UP";
    pushLastRepMs = 0;
    pushStableUp = 0;
    pushStableDown = 0;
    pushSessionEl.textContent = "0";
    pushPhaseEl.textContent = "–§–∞–∑–∞: ‚Äî";
    pushAngleEl.textContent = "–£–≥–æ–ª: ‚Äî";
    pushHintEl.textContent = "";
  }

  function pushupsResetTotal(){
    if (!confirm("–°–±—Ä–æ—Å–∏—Ç—å –æ–±—â–∏–π —Å—á—ë—Ç—á–∏–∫ –æ—Ç–∂–∏–º–∞–Ω–∏–π –∏ —Å–∏–ª—É?")) return;
    state.pushupsTotal = 0;
    saveState();
    renderStrength();
  }

  function addRep(){
    pushupsSession++;
    pushSessionEl.textContent = String(pushupsSession);

    state.pushupsTotal = (Number(state.pushupsTotal) || 0) + 1;
    saveState();
    renderStrength();
  }

  function updatePushups(kp){
    const ang = bestElbowAngle(kp);
    if (ang == null) {
      pushHintEl.textContent = "–ù–µ –≤–∏–∂—É —Ä—É–∫—É. –ü–æ—Å—Ç–∞–≤—å –∫–∞–º–µ—Ä—É —Å–±–æ–∫—É (–ø—Ä–æ—Ñ–∏–ª—å), —á—Ç–æ–±—ã –±—ã–ª–∏ –≤–∏–¥–Ω—ã –ø–ª–µ—á–æ‚Äì–ª–æ–∫–æ—Ç—å‚Äì–∑–∞–ø—è—Å—Ç—å–µ.";
      pushAngleEl.textContent = "–£–≥–æ–ª: ‚Äî";
      pushStableUp = 0; pushStableDown = 0;
      return;
    }

    pushHintEl.textContent = "";
    pushAngleEl.textContent = `–£–≥–æ–ª: ${Math.round(ang)}¬∞`;

    if (ang >= PUSH_UP_ANGLE) {
      pushStableUp++;
      pushStableDown = 0;
    } else if (ang <= PUSH_DOWN_ANGLE) {
      pushStableDown++;
      pushStableUp = 0;
    } else {
      pushStableUp = Math.max(0, pushStableUp - 1);
      pushStableDown = Math.max(0, pushStableDown - 1);
    }

    const now = Date.now();

    if (pushPhase === "UP") {
      pushPhaseEl.textContent = "–§–∞–∑–∞: –í–í–ï–†–•";
      if (pushStableDown >= PUSH_STABLE_FRAMES) {
        pushPhase = "DOWN";
        pushStableDown = 0;
        pushPhaseEl.textContent = "–§–∞–∑–∞: –í–ù–ò–ó";
      }
    } else {
      pushPhaseEl.textContent = "–§–∞–∑–∞: –í–ù–ò–ó";
      if (pushStableUp >= PUSH_STABLE_FRAMES) {
        if (now - pushLastRepMs > PUSH_MIN_INTERVAL_MS) {
          addRep();
          pushLastRepMs = now;
        }
        pushPhase = "UP";
        pushStableUp = 0;
        pushPhaseEl.textContent = "–§–∞–∑–∞: –í–í–ï–†–•";
      }
    }
  }

  // ====== Buttons: strict ======
  btnStrictOn.onclick = async () => {
    try {
      await ensureCameraOn();
      strictEnabled = true;

      btnStrictOn.disabled = true;
      btnStrictOff.disabled = false;

      lastPoseSeenMs = Date.now();
      eyesClosedSince = null;
      postureBadSince = null;
      violationReason = "";
      violationActive = false;

      setStatus("ok", "–ö–æ–Ω—Ç—Ä–æ–ª—å: –≤–∫–ª—é—á—ë–Ω");
      setAllText($violation(), "");
    } catch(e) {
      console.error(e);
      setStatus("warn", "–ö–æ–Ω—Ç—Ä–æ–ª—å: –æ—à–∏–±–∫–∞");
      setAllText($violation(), "–û—à–∏–±–∫–∞. –û—Ç–∫—Ä–æ–π –∫–æ–Ω—Å–æ–ª—å (F12) –∏ –ø—Ä–∏—à–ª–∏ —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏.");
    }
  };

  btnStrictOff.onclick = async () => {
    strictEnabled = false;
    btnStrictOn.disabled = false;
    btnStrictOff.disabled = true;

    stopSiren();
    clearAllViolationUI();
    setStatus("", "–ö–æ–Ω—Ç—Ä–æ–ª—å: –≤—ã–∫–ª—é—á–µ–Ω");
    setAllText($poseState(), "");
    setAllText($eyesState(), "");
    setAllText($postureState(), "");

    await stopCameraIfUnused();
  };

  // ====== Buttons: pushups ======
  btnPushOn.onclick = async () => {
    try {
      await ensureCameraOn();
      pushupsEnabled = true;
      btnPushOn.disabled = true;
      btnPushOff.disabled = false;

      // —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª–∏ –¥—Ä—É–≥ –¥—Ä—É–≥—É: –∫–æ–≥–¥–∞ –æ—Ç–∂–∏–º–∞–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã, –∫–æ–Ω—Ç—Ä–æ–ª—å –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å, –Ω–æ —Å–∏—Ä–µ–Ω—É –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ–º –≤ —Ä–µ–∂–∏–º–µ –æ—Ç–∂–∏–º–∞–Ω–∏–π.
      // (—Å–µ–π—á–∞—Å —Å–∏—Ä–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –æ—Ç strictEnabled)
      pushupsResetSession();
      pushHintEl.textContent = "–°—Ç–∞—Ä—Ç. –î–µ–ª–∞–π –æ—Ç–∂–∏–º–∞–Ω–∏—è. –ö–∞–º–µ—Ä–∞ –ª—É—á—à–µ —Å–±–æ–∫—É (–ø—Ä–æ—Ñ–∏–ª—å).";
    } catch(e) {
      console.error(e);
      pushHintEl.textContent = "–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ. –û—Ç–∫—Ä–æ–π –∫–æ–Ω—Å–æ–ª—å (F12) –∏ –ø—Ä–∏—à–ª–∏ —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏.";
    }
  };

  btnPushOff.onclick = async () => {
    pushupsEnabled = false;
    btnPushOn.disabled = false;
    btnPushOff.disabled = true;
    pushHintEl.textContent = "–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.";
    await stopCameraIfUnused();
  };

  btnPushResetSession.onclick = () => pushupsResetSession();
  btnPushResetTotal.onclick = () => pushupsResetTotal();

  // =============================
  // Main camera loop: runs while cameraOn
  // =============================
  async function loop(){
    if (!cameraOn || !detector) return;

    const poses = await detector.estimatePoses(videoEl, { flipHorizontal: true });
    const hasPose = !!(poses && poses.length && poses[0].keypoints && poses[0].keypoints.length);

    ctx.save();
    ctx.clearRect(0,0,canvasEl.width,canvasEl.height);
    drawVideoCover(videoEl, ctx, canvasEl.width, canvasEl.height);

    if (hasPose) {
      const kp = poses[0].keypoints;
      ctx.strokeStyle = "rgba(99,102,241,0.9)";
      ctx.lineWidth = 3;
      ctx.fillStyle = "rgba(34,197,94,0.9)";

      for (const [a,b] of EDGES) {
        const A = kp[a], B = kp[b];
        if ((A.score ?? 0) > 0.25 && (B.score ?? 0) > 0.25) {
          const a2 = mapToCanvas(A.x, A.y);
          const b2 = mapToCanvas(B.x, B.y);
          ctx.beginPath();
          ctx.moveTo(a2.cx, a2.cy);
          ctx.lineTo(b2.cx, b2.cy);
          ctx.stroke();
        }
      }
      for (const p of kp) {
        if ((p.score ?? 0) > 0.25) {
          const c = mapToCanvas(p.x, p.y);
          drawKeypoint(c.cx, c.cy);
        }
      }
    }
    ctx.restore();

    // Strict checks (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ)
    if (strictEnabled) {
      updatePresence(hasPose);

      const cfg = getPresetConfig();
      if (strictModeEl.value === "posture") {
        if (hasPose) checkPosture(poses[0].keypoints);
        else {
          setAllText($postureState(), "–Ω–µ –≤–∏–∂—É ü§∑");
          postureBadSince = null;
          clearViolationIfReason("posture");
        }
        eyesClosedSince = null;
        clearViolationIfReason("eyes");
      }
      else if (strictModeEl.value === "eyes") {
        await checkEyes();
        postureBadSince = null;
        clearViolationIfReason("posture");
      }
      else {
        eyesClosedSince = null;
        postureBadSince = null;
        clearViolationIfReason("eyes");
        clearViolationIfReason("posture");
      }
    } else {
      // —á–∏—Å—Ç–∏–º —Å—Ç–∞—Ç—É—Å—ã –∫–æ–Ω—Ç—Ä–æ–ª—è, –µ—Å–ª–∏ –≤—ã–∫–ª—é—á–µ–Ω
      setAllText($poseState(), "");
      setAllText($eyesState(), "");
      setAllText($postureState(), "");
    }

    // Push-ups feature (–æ—Ç–¥–µ–ª—å–Ω–æ)
    if (pushupsEnabled) {
      if (hasPose) updatePushups(poses[0].keypoints);
      else {
        pushHintEl.textContent = "–ù–µ –≤–∏–∂—É –ø–æ–∑—É. –ü–æ–¥–æ–π–¥–∏ –≤ –∫–∞–¥—Ä/–ø–æ—Å—Ç–∞–≤—å –∫–∞–º–µ—Ä—É –Ω–∏–∂–µ.";
        pushAngleEl.textContent = "–£–≥–æ–ª: ‚Äî";
      }
    }

    rafId = requestAnimationFrame(loop);
  }

  // =============================
  // Init
  // =============================
  function escapeHtml(s){
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  // strength UI duplicate refs (need after elements exist)
  // (–æ–Ω–∏ —É–∂–µ –æ–±—ä—è–≤–ª–µ–Ω—ã –≤—ã—à–µ, –Ω–æ —Ç—É—Ç –æ–±–Ω–æ–≤–ª—è–µ–º, —á—Ç–æ–±—ã –ª–∏–Ω—Ç–µ—Ä –Ω–µ —Ä—É–≥–∞–ª—Å—è)
  render();
  setStatus("", "–ö–æ–Ω—Ç—Ä–æ–ª—å: –≤—ã–∫–ª—é—á–µ–Ω");
  setAllText($violation(), "");

  if (state.running && typeof state.startMs === "number") startTick();
  else { btnStart.disabled = false; btnStop.disabled = true; btnSkipBreak.disabled = true; }

  // disable feature stop buttons initially
  btnStrictOff.disabled = true;
  btnPushOff.disabled = true;

</script>
</body>
</html>
